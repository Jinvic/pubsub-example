# 📣 Go Pub/Sub 发布订阅模型示例

> [!NOTE]
> This readme is generated by Qwen3.

一个轻量级、并发安全的发布-订阅（Publish-Subscribe）模型示例，使用 Go 语言实现。

## ✨ 特性

- **完全并发安全**：使用 `sync.RWMutex` 保护共享状态。
- **灵活订阅**：支持订阅具体主题或所有主题（`""`）。
- **自动/手动注册**：创建实例时可选择是否自动注册到全局管理器。
- **异步非阻塞发布**：发布消息不阻塞，通过 Goroutine 异步投递。
- **缓冲消息通道**：订阅者自带可配置缓冲区的消息通道。
- **优雅资源管理**：提供 `Close` 和 `Unregister` 方法清理资源。
- **唯一 ID 生成**：基于 UUID 生成带类型前缀的唯一 ID。

## 📦 安装

```bash
go get github.com/Jinvic/pubsub-exmaple
```

## 🚀 快速开始

```go
package main

import (
    "fmt"
    "time"
    pubsub "Jinvic/pubsub-exmaple"
)

func main() {
    // 1. 创建发布者
    publisher := pubsub.NewPublisher(true)

    // 2. 创建订阅者
    subscriber := pubsub.NewSubscriber(10, true)

    // 3. 订阅主题
    subscriber.Subscribe(publisher.ID, "news")
    subscriber.Subscribe(publisher.ID, "") // 订阅所有主题

    // 4. 发布消息
    publisher.Publish([]string{"news"}, []byte("Hello, World!"))

    // 5. 消费消息 (阻塞)
    msg := subscriber.Consume()
    fmt.Printf("Received: %s\n", string(msg.Data))

    // 或使用非阻塞方式
    if msg, ok := subscriber.TryConsume(); ok {
        fmt.Printf("Received: %s\n", string(msg.Data))
    }

    // 6. 清理资源
    subscriber.Close() // 关闭通道并自动注销
}
```

## 🧰 API 参考

### `NewPublisher(autoRegister bool) *Publisher`

创建新的发布者。

- `autoRegister=true`：创建后自动注册到全局 `Publishers` 映射。
- 返回：`*Publisher`

### `NewSubscriber(bufferSize int, autoRegister bool) *Subscriber`

创建新的订阅者。

- `bufferSize<=0`：使用默认值 10。
- `autoRegister=true`：创建后自动注册。
- 返回：`*Subscriber`

### `Publisher` 方法

| 方法 | 描述 |
|------|------|
| `Publish(topics []string, data []byte)` | 向指定主题发布消息。 |
| `Unregister()` | 从全局映射中注销该发布者。 |

### `Subscriber` 方法

| 方法 | 描述 |
|------|------|
| `Subscribe(pubID, topic string)` | 订阅某个发布者的主题。 |
| `UnsubscribeTopic(pubID, topics []string)` | 取消订阅指定主题。 |
| `UnsubscribePublisher(pubID)` | 取消订阅该发布者的所有主题。 |
| `Receive(msg Message)` | 接收消息（由发布者调用）。 |
| `Consume() Message` | 阻塞式消费一条消息。 |
| `TryConsume() (Message, bool)` | 非阻塞消费，返回 `(消息, 是否收到)`。 |
| `Close()` | 关闭消息通道并注销订阅者。 |

### 全局函数

| 函数 | 描述 |
|------|------|
| `RegisterPublisher`, `RegisterSubscriber` | 手动注册实例。 |
| `UnregisterPublisher`, `UnregisterSubscriber` | 手动注销实例。 |
| `GetPublisher`, `GetSubscriber` | 通过 ID 获取实例。 |

## ⚠️ 注意事项

1. **主题匹配**：
   - 订阅 `""` 表示接收该发布者的**所有**消息。
   - 订阅具体主题 `"news"` 只接收该主题消息。
   - 两者可以同时存在。

2. **资源清理**：
   - 建议在 `defer` 中调用 `subscriber.Close()` 或 `publisher.Unregister()`。
   - `Close()` 会关闭 `MsgChan`，后续 `Receive` 调用将 panic。

3. **并发安全**：
   - 所有公开方法都是并发安全的。
   - `Consume` 和 `TryConsume` 可以在多个 Goroutine 中安全调用。

4. **ID 唯一性**：基于 `github.com/google/uuid` 保证全局唯一。

---

## 🔍 Todo List

1. **错误处理**：
   - `Subscribe`/`Unsubscribe` 方法可以返回 `error`，例如当发布者不存在时。
   - `Publish` 可以返回发送成功的订阅者数量。

2. **上下文支持**：
   - 为 `Publish` 添加 `context.Context` 参数，支持超时或取消。

3. **消息序列化**：
   - 提供 `Message` 的 JSON 序列化方法，便于日志或网络传输。

4. **性能监控**：
   - 添加计数器统计发布/订阅次数。

5. **文档注释**：
   - 为所有导出的类型和方法添加 `godoc` 注释。

6. **示例目录**：
   - 添加 `examples/` 目录，提供更复杂的使用场景。
